var viewData=null;function getHourDisplay(n,e){var t=e?e+"_min":"hours_min",a=e?e+"_max":"hours_max",i=e||"hours";return n[t]&&n[a]&&n[t]!=n[a]?n[t]+"-"+n[a]:n[i]}function switchTabByHash(n){var e=Util.parseUrlHash(window.location.hash),t=e?e.type:"";t||(t="sitePlan"),switchLightType(t,n)}function switchLightType(n,e){n&&!e&&$(".nav-sub a[type='"+n+"']").closest("li").addClass("active"),jQuery.each($(".tab-body-light .tab-page"),function(e,t){n==$(t).attr("type")?$(t).show():$(t).hide()}),onTabChanged(n)}function onTabChanged(n){viewData?renderTabPage(viewData,n):queryData(n)}function queryData(n){var e=getQueryStringValueByName("id",window.location.href);$.ajax({url:"/api/queryEvaluateLightDetail",data:{id:e},dataType:"json",success:function(e){renderTabPage(viewData=e.data,n),Util.updateTitleTextBySitePlanData(e.data)},error:function(n){console.log("response: ",n)}})}function renderTabPage(n,e){var t=$(".tab-page[type='"+e+"']");t.attr("updateDisplay");"sitePlan"==e?renderSitePlan(viewData,t):"elevationPlan"==e?renderElevationPlanPage(viewData,t):"floor"==e&&renderFloorPage(viewData,t),showViewCount(n)}function renderSitePlan(n,e){var t=n?n.lightSitePlan:null;if(t){var a=geSitePlanBuildingAvgLightHour(t);if(a){var i=e.find(".building-avg-hours");i.html("");var o=maxStandartLightHours(a);a.forEach(function(n){var e=getHourDisplay(n);Util.addHBar(i,{label:n.buildingNo+"栋(h)",value:e,percent:100*n.hours/o,level:calcLightHourLevel(n.hours)})}),!0}t.comment&&Util.renderComment(e,t.comment),t.light_image_url?(e.find(".image-static-box img").attr("src",t.light_image_url),e.find(".number-box").show()):e.find(".number-box").hide(),t.effect_image_url&&e.find(".image-effect-box img").attr("src",t.effect_image_url)}toggleShowDetail(e,getEmptyView(),!t)}function getEmptyView(){return $(".empty-content-info")}function renderElevationPlanPage(n,e,t){var a=n?n.lightElevationPlans:null,i=a&&a.length>0;if(toggleShowDetail(e,getEmptyView(),!i),i){var o=e.find(".building-no-nav"),r="";if(!o.html()){for(var l in a){var u=a[l];r+="<li><a building-no='"+u.building_no+"'>"+u.building_no+"#</a></li>"}o.html(r)}t||(t=a[0].building_no),o.find("a").click(function(n){updateNavActiveOnItemClick($(this)),renderBuildingLight(a,e,$(this).attr("building-no"))});var d=o.find("a");for(var l in d)if($(d[l]).attr("building-no")==t){$(d[l]).click();break}e.attr("updateDisplay",!1)}}function renderBuildingLight(n,e,t){var a=null;for(var i in n)if(n[i].building_no==t){a=n[i];break}var o=e.find(".elevation-plan-page"),r=!isValidElevationItemData(a);if(toggleShowDetail(o,getEmptyView(),r),!r){var l=o.find(".head-box");a.building_angel?l.html("<div>朝向："+a.building_angel+"度</div>"):l.html("");var u=o.find(".desc-sub"),d=o.find(".hours-box");d.html("");var c=parseExtraInfoKey(a,"floor_light_info");if(c){var g=maxStandartLightHours(c);c.forEach(function(n){var e="";e=n.floorStart==n.floorEnd?n.floorStart+"层(h)":n.floorStart+"-"+n.floorEnd+"层(h)";var t=100*parseFloat(n.hours)/g,a=getHourDisplay(n);Util.addHBar(d,{label:e,value:a,subValue:n.comment,percent:t,level:calcLightHourLevel(n.hours),minWidth:"120px"})}),u.show()}else u.hide();Util.renderComment(o,a.comment),renderImage(o,a.light_image_url)}}function renderFloorPage(n,e,t){var a=n?n.lightFloors:null,i=a&&a.length>0;if(toggleShowDetail(e,getEmptyView(),!i),i){var o=e.find(".building-no-nav"),r=Util.groupArrayByKey(a,"building_no");o.html("");var l="",u="";for(var d in r){r[d];l+="<li><a building-no='"+d+"'>"+d+"栋</a></li>",u||(u=d)}o.html(l),t||(t=u),o.find("a").click(function(n){updateNavActiveOnItemClick($(this));var t=$(this).attr("building-no");renderFloorPageOnBuilding(r[t],e,t)});var c=o.find("a");for(var d in c)if($(c[d]).attr("building-no")==t){$(c[d]).click();break}}}function renderFloorPageOnBuilding(n,e,t){e.find(".floor-page"),e.find(".empty-content-info");var a=e.find(".floor-no-nav");a.html("");var i="",o="";for(var r in n){var l=n[r].floor_no;i+="<li><a floor-no='"+l+"'>"+l+"层</a></li>",o||(o=l)}a.html(i),a.find("a").click(function(a){updateNavActiveOnItemClick($(this));var i=$(this).attr("floor-no");renderFloorPageOnFloor(n,e,t,i)});a.find("a");o&&a.find("a[floor-no='"+o+"']").click()}function renderFloorPageOnFloor(n,e,t,a){var i=e.find(".floor-page"),o=null;if(n&&n.length>0)if(a){for(var r in n)if(n[r].floor_no==a){o=n[r];break}}else a=n[0].floor_no,o=n[0];var l=!isValidFloorItemData(o);if(toggleShowDetail(i,getEmptyView(),l),!l){var u=i.find(".hours-box");u.html("");var d=parseExtraInfoKey(o,"direction_hours");if(d&&d.south_hours&&d.east_hours&&d.west_hours){var c=maxFloorDirectionHours(d),g=["south_hours","east_hours","west_hours"];for(r=0;r<g.length;r++){var s=g[r],f=getDirectionLabel(s),h=d[s],m=getHourDisplay(d,s),v=100*parseFloat(h)/c;Util.addHBar(u,{label:f,value:m,subValue:"",percent:v,level:calcLightHourLevel(h),minWidth:"120px"})}}Util.renderComment(i,o.comment),renderImage(i,o.light_image_url)}}function renderImage(n,e){e?(n.find(".image-box img").attr("src",e),n.find(".number-box").show()):(n.find(".image-box img").attr("src",""),n.find(".number-box").hide())}function maxFloorDirectionHours(n){var e=0;for(var t in n)e=Math.max(e,parseFloat(n[t]));return e=Math.max(8,e)}function getDirectionLabel(n){return"south_hours"==n?"南面(h)":"east_hours"==n?"东面(h)":"west_hours"==n?"西面(h)":void 0}function isValidElevationItemData(n){return!(!n||!(n.light_image_url||n.extra_info||n.comment))}function isValidFloorItemData(n){return!(!n||!n.light_image_url&&!n.comment)}function toggleShowDetail(n,e,t){t?(e.show(),n.hide()):(e.hide(),n.show()),toggleShowBottomDesc(t)}function toggleShowBottomDesc(n){var e=$(".bottom-desc-box");n?e.hide():e.show()}function showViewCount(n){var e="";n&&n.lightSitePlan&&((e=n.lightSitePlan.view_count)||(e=0));e=""==e?0:4*(e+num)+3,document.getElementById("see_count").innerHTML='<font color="#BEBEBE">'+e+"</font>"}$(function(){PageRenderer.initTitleBar();var n=getQueryStringValueByName("id",window.location.href);$(".tab-header .unit a").on("click",function(){location.href="/detailUnit.html?id="+n}),$.ajax({url:"/api/queryZan",data:{real_estate_id:n},dataType:"json",success:function(e){commonHandleResponse(e,function(t){num=e.data.zan_number,document.getElementById("zan-num").innerHTML='<font color="#BEBEBE">'+ ++num+"</font>",$(".zan").on("click",function(){$.ajax({url:"/api/zan",data:{real_estate_id:n,zan_number:1},dataType:"json",success:function(n){commonHandleResponse(n,function(n){document.getElementById("zan-num").innerHTML='<font color="#BEBEBE">'+ ++num+"</font>",document.getElementById("zan").innerHTML='<img src="image/zan_down.png" height="40" width="40">'})},error:function(n){console.log(n)}})})},function(e){num=0,document.getElementById("zan-num").innerHTML='<font color="#BEBEBE">'+num+"</font>",$(".zan").on("click",function(){$.ajax({url:"/api/zan",data:{real_estate_id:n,zan_number:1},dataType:"json",success:function(n){commonHandleResponse(n,function(n){document.getElementById("zan-num").innerHTML='<font color="#BEBEBE">'+ ++num+"</font>",document.getElementById("zan").innerHTML='<img src="image/zan_down.png" height="40" width="40">'})},error:function(n){console.log(n)}})})})},error:function(e){num=0,document.getElementById("zan-num").innerHTML='<font color="#BEBEBE">'+num+"</font>",$(".zan").on("click",function(){$.ajax({url:"/api/zan",data:{real_estate_id:n,zan_number:1},dataType:"json",success:function(n){commonHandleResponse(n,function(n){document.getElementById("zan-num").innerHTML="("+ ++num+")",document.getElementById("zan").innerHTML='<img src="image/zan_down.png" height="40" width="40">'})},error:function(n){console.log(n)}})})}}),$(".nav-sub a").on("click",function(){updateNavActiveOnItemClick($(this));var n=Util.parseUrlHash(window.location.hash);n||(n={}),n.type=$(this).attr("type"),window.location.hash=Util.toHashString(n)}),$(window).on("hashchange",function(n){n.preventDefault(),switchTabByHash(!0)}),switchTabByHash(!1),Util.trackDataView({id:n,type:"light"})});