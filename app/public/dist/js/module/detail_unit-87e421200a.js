var unitNo,viewData=null;function trackUnitNoView(e){e||(e=getHashUnitNo());var a=getQueryStringValueByName("id",window.location.href);Util.trackDataView({id:a,unit_no:e,type:"unit"})}function getHashUnitNo(){var e=Util.parseUrlHash(window.location.hash),a=e?e.unitNo:"";return a&&(a=decodeURIComponent(a)),a}function switchUnitNoByHash(e){Util.parseUrlHash(window.location.hash);var a=getHashUnitNo();viewData?renderPageOnUnitNo(a,e):queryData(function(){renderPageOnUnitNo(a,e)})}function queryData(e){var a=getQueryStringValueByName("id",window.location.href);$.ajax({url:"/api/queryEvaluateUnitDetail",data:{id:a},dataType:"json",success:function(a){viewData=a.data,e()},error:function(e){console.debug(e)}})}function initUnitNoNavIfNot(e,a){var i=$(".nav-unit-no");if(!(i.find("li").length>0)){i.html("");var t="",n="";for(var r in e)t+="<li><a unit-no='"+r+"'>"+r+"</a></li>",n||(n=r);i.html(t),i.find("a[unit-no='"+a+"']").parents("li").addClass("active"),i.find("a").click(function(e){updateNavActiveOnItemClick($(this));var a=Util.parseUrlHash(window.location.hash);a||(a={});var i=$(this).attr("unit-no");a.unitNo=i,window.location.hash=Util.toHashString(a),trackUnitNoView(i)})}}function renderPageOnUnitNo(e){var a=null;viewData&&(e||(e=Object.keys(viewData)[0]),a=viewData[e]);var i=$(".unit-panels"),t=$(".empty-content-info");toggleShowContent(i,t,!a),viewData&&initUnitNoNavIfNot(viewData,e),a&&(renderSynthesis(i,a),renderBasicInfo(i,a),renderRoomArea(i,a),renderRegionFlow(i,a),renderWindowAndVentilate(i,a),renderDetail(i,a))}function renderSynthesis(e,a){var i=Util.convertToCssClassKey("unit_synthesis"),t=e.find("."+i),n=a.unit_basic_info;t.find(".title").html(n.unit_no),Util.updateTitleTextByRealEstateName(n),t.find(".comment").html(n.synthesis_comment?"点评："+n.synthesis_comment:"");var r=t.find(".bars");r.html("");var o={unit_basic_info:"1.基本信息",unit_room_area:"2.面积尺寸",unit_region_flow:"3.分区流线",unit_window_ventilate:"4.采光通风",unit_detail:"5.细节"},l=0;for(var d in o){var v=o[d];a[d]&&a[d].score&&(Util.addHBar(r,{label:v,value:a[d].score+"分",percent:a[d].score,minWidth:"22%"}),l+=Number(a[d].score))}l>0&&(l/=5);var s=n.total_score;s=s?Number(s):l,updateScore(t,s=PageRenderer.formatScore(s,"分"))}function renderBasicInfo(e,a){var i="unit_basic_info",t=Util.convertToCssClassKey(i);renderCommon(e,a,i,t);var n=e.find("."+t),r=a[i];r||(r={});var o=n.find(".bars"),l=Math.max(r.sale_area,r.real_inside_area);if(o.html(""),r.efficiency){var d=Number(r.efficiency),v=(100*d).toFixed(1)+"%",s=getLevel("efficiency",d),u=getBadLevel("efficiency");Util.addHBar(o,{label:"实际得房率",value:v,percent:100*parseFloat(r.efficiency),level:s,badLevel:u})}r.real_inside_area&&Util.addHBar(o,{label:"实际套内面积(方)",value:r.real_inside_area,percent:100*r.real_inside_area/l}),r.sale_area&&Util.addHBar(o,{label:"建筑面积(方)",value:r.sale_area,percent:100*r.sale_area/l});var c=r.extra_info;if(c){var f=JSON.parse(c);if(f){var m=f.sendAreas,_=0;for(var h in m)_+=Number(m[h].size);for(var h in _=_.toFixed(1),Util.addHBar(o,{label:"总增值面积(方)",value:_,percent:100*_/l}),m)Util.addHBar(o,{label:m[h].name,value:m[h].size,percent:100*m[h].size/l})}}var p="";r.room_count&&r.living_room_count&&r.toliet_count&&(p=r.room_count+"室"+r.living_room_count+"厅"+r.toliet_count+"卫"),p&&Util.addHBar(o,{label:"户型配置",value:p,type:"plain_value"});var g=Util.formatRatioDisplay(r,"width","depth");g&&Util.addHBar(o,{label:"户型开进比",value:g,type:"plain_value",level:getLevel("unitWidthDepthRatio",g),badLevel:"D"});var b=Util.formatRatioDisplay(r,"square_perimeter","perimeter");b&&Util.addHBar(o,{label:"户型方正率",value:b,type:"plain_value",level:getLevel("unitSquareRatio",b),badLevel:"D"});var w=r.view_count;w||(w=0),$(".view-count-box .view-count").html(w)}function renderRoomArea(e,a){var i="unit_room_area",t=Util.convertToCssClassKey(i);renderCommon(e,a,i,t);var n=e.find("."+t),r=a[i],o=a.unit_basic_info;r||(r={});var l,d=n.find(".bars");d.html("");var v=r.extra_info;if(v){var s=JSON.parse(v);s&&(l=s.rooms)}if(l){var u=0;a.unit_basic_info&&a.unit_basic_info.real_inside_area&&(u=a.unit_basic_info.real_inside_area);var c=0,f=[];for(var m in l){var _=l[m];c=Math.max(_.area,c)}for(var m in l){_=l[m];var h="",p=Util.UNIT_STANDART[_.room_type];for(var g in p){if("passage"==_.room_type){if((u>0?_.area/u:0)<=p[g]){h=g;break}}else if("storage"==_.room_type){if((u>0?_.area/u:0)>=p[g]){h=g;break}}else if(_.area>=p[g]){h=g;break}}var b=getBadLevel(_.room_type),w=0,U="";["bed_room","study_room","living_room","dining_room","living_dining_room"].indexOf(_.room_type)>=0&&_.depth&&_.width&&(w=(_.width/_.depth).toFixed(2)),w&&w<=.7&&(w="<font style='color:red'>"+w+"</font>");var y="";if(w){y=w<=.7?"开进比 <font style='color:red'>"+w+"</font>":"开进比 "+w}if(U=y+"","storage"==_.room_type||"passage"==_.room_type){var N=o.real_inside_area,B=100*Number(_.area)/Number(N);U="占比 "+(B=B.toFixed(2))+"%"}f.push({label:_.room_name+"(方)",subLabel:U,value:_.area,percent:100*_.area/c,level:h,badLevel:b})}for(var m in f){var D=f[m];Util.addHBar(d,{label:D.label,subLabel:D.subLabel,value:D.value,percent:D.percent,level:D.level,badLevel:D.badLevel})}}}function renderRegionFlow(e,a){var i="unit_region_flow",t=Util.convertToCssClassKey(i);renderCommon(e,a,i,t);var n=e.find("."+t),r=a[i];r||(r={});var o=n.find(".bars");o.html(""),null!=r.static_region_count&&Util.addHBar(o,{label:"静区个数",value:r.static_region_count,type:"plain_value"}),null!=r.dynamic_region_count&&Util.addHBar(o,{label:"动区个数",value:r.dynamic_region_count,type:"plain_value"});var l,d=r.distances;d&&(l=JSON.parse(d));var v=0;for(var s in l)l[s].k&&l[s].v&&(v=Math.max(v,Number(l[s].v)));for(var s in l){var u=l[s],c=u.v;if(c){var f=getLevel("region_flow",Number(c),!0),m=getBadLevel("region_flow");Util.addHBar(o,{label:u.k,value:c,percent:100*c/v,level:f,badLevel:m})}}}function renderWindowAndVentilate(e,a){var i="unit_window_ventilate",t=Util.convertToCssClassKey(i);renderCommon(e,a,i,t);var n,r=e.find("."+t),o=a[i];o||(o={});var l=o.extra_info;l&&(n=JSON.parse(l));var d=r.find(".bars");if(d.html(""),n){var v=n.room_windows,s=n.ventilate;for(var u in v){(_=v[u]).ratio=Number(_.window_width)/Number(_.depth)}var c={},f=maxValues(v,"ratio"),m=getBadLevel("window_depth_ratio");for(var u in v){var _=v[u],h=getLevel("window_depth_ratio",isNaN(_.ratio)?0:_.ratio);_.ratio||(_.ratio=0);var p=(100*_.ratio).toFixed(1);Util.addHBar(d,{label:_.room_name+"窗深比",value:p+"%",percent:p/f,level:h,badLevel:m}),c[_.orientation]?c[_.orientation]++:c[_.orientation]=1}var g={south:"南房间数",north:"北房间数",east_west:"东西房间数",middle:"中庭房间数",no:"暗房间数"};for(var i in c)Util.addHBar(d,{label:g[i],value:c[i],type:"plain_value"});var b={1:"客厅->餐厅",2:"客厅->厨房/卫生间/卧室/书房",3:"卧室->客厅/餐厅",4:"卧室->厨房/卫生间/卧室/书房"};if(s){var w={south_north:{name:"南北通风+侧面通风",level:"A"},side:{name:"南北通风",level:"B"},middle:{name:"中庭通风",level:"C"},single_side:{name:"单面通风",level:"D"}}[s.type];if(Util.addHBar(d,{label:"通风类型",value:w.name,type:"plain_value",level:w.level,badLevel:"D"}),s.paths)for(var u in s.paths){var U=Number(u)+1,y=b[s.paths[u]];_.convect_type,_.ventilate_type;Util.addHBar(d,{label:"通风路径"+U,value:y,type:"plain_value"})}}}}function renderDetail(e,a){var i="unit_detail",t=Util.convertToCssClassKey(i);renderCommon(e,a,i,t);var n=e.find("."+t),r=a[i];r||(r={});var o=n.find(".sections");o.html("");var l={door:"门厅",living_room:"客厅",dining_room:"餐厅",bedroom:"卧室,书房",kitchen:"厨房",toliet:"卫生间",balcony:"阳台"},d=0;for(var v in l){var s,u=r[v];s=u?JSON.parse(u):{};var c=$($("#detail-section-tpl").html());c.find(".section-title").html(l[v]),c.find(".sections-items-wrap").html();var f=Util.UNIT_STANDART.detail_items[v];for(var m in f){d++;var _=s[Util.UNIT_STANDART.detai_item_key[m]],h=$($("#detail-section-item-tpl").html());h.find(".name").html(d+"."+f[m]),_?(h.find(".value").html("<img src='/image/checked.png'></img>"),h.find(".value").removeClass("color-warn")):(h.find(".value").html("<img src='/image/cross.png'></img>"),h.find(".value").addClass("color-warn")),c.find(".section-items-wrap").append(h)}o.append(c)}}function renderCommon(e,a,i,t){var n=e.find("."+t),r=a[i];r||(r={}),updateScore(n,PageRenderer.formatScore(r.score,"分"));var o=r.image_url;"undefined"==o&&(o=""),Util.renderImage(n,o),n.find(".comment").html(r.comment?"点评："+r.comment:"")}function updateScore(e,a){var i=e.find(".panel-title .score");a?i.html(a).show():i.hide()}function maxValues(e,a){var i=0;for(var t in e)isNaN(e[t][a])||(i=Math.max(e[t][a],i));return i}function getLevel(e,a,i){var t="",n=Util.UNIT_STANDART[e];for(var r in n){if(i?a<n[r]:a>=n[r]){t=r;break}}return t}function getBadLevel(e){var a=Util.UNIT_STANDART[e],i=0,t=null;return a&&(i=(t=Object.keys(a)).length),i<=0||!t?"D":t[i-1]}function toggleShowContent(e,a,i){i?(a.show(),e.hide()):(a.hide(),e.show())}$(function(){PageRenderer.initTitleBar();var e=getQueryStringValueByName("id",window.location.href);$(".tab-header .light a").on("click",function(){location.href="/detail.html?id="+e}),$(window).on("hashchange",function(e){e.preventDefault(),switchUnitNoByHash(!0)}),switchUnitNoByHash(!1),trackUnitNoView(unitNo=getHashUnitNo())});