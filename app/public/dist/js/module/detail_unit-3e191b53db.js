var num,unitNo,viewData=null;function trackUnitNoView(e){e||(e=getHashUnitNo());var a=getQueryStringValueByName("id",window.location.href);Util.trackDataView({id:a,unit_no:e,type:"unit"})}function getHashUnitNo(){var e=Util.parseUrlHash(window.location.hash),a=e?e.unitNo:"";return a&&(a=decodeURIComponent(a)),a}function switchUnitNoByHash(e){Util.parseUrlHash(window.location.hash);var a=getHashUnitNo();viewData?renderPageOnUnitNo(a,e):queryData(function(){renderPageOnUnitNo(a,e)})}function queryData(e){var a=getQueryStringValueByName("id",window.location.href);$.ajax({url:"/api/queryEvaluateUnitDetail",data:{id:a},dataType:"json",success:function(a){viewData=a.data,e()},error:function(e){console.debug(e)}})}function initUnitNoNavIfNot(e,a){var n=$(".nav-unit-no");if(!(n.find("li").length>0)){n.html("");var t="",i="";for(var r in e)t+="<li><a unit-no='"+r+"'>"+r+"</a></li>",i||(i=r);n.html(t),n.find("a[unit-no='"+a+"']").parents("li").addClass("active"),n.find("a").click(function(e){updateNavActiveOnItemClick($(this));var a=Util.parseUrlHash(window.location.hash);a||(a={});var n=$(this).attr("unit-no");a.unitNo=n,window.location.hash=Util.toHashString(a),trackUnitNoView(n)})}}function renderPageOnUnitNo(e){var a=null;viewData&&(e||(e=Object.keys(viewData)[0]),a=viewData[e]);var n=$(".unit-panels"),t=$(".empty-content-info");toggleShowContent(n,t,!a),viewData&&initUnitNoNavIfNot(viewData,e),a&&(renderSynthesis(n,a),renderBasicInfo(n,a),renderRoomArea(n,a),renderRegionFlow(n,a),renderWindowAndVentilate(n,a),renderDetail(n,a))}function renderSynthesis(e,a){var n=Util.convertToCssClassKey("unit_synthesis"),t=e.find("."+n),i=a.unit_basic_info;t.find(".title").html(i.unit_no),Util.updateTitleTextByRealEstateName(i),t.find(".comment").html(i.synthesis_comment?"点评："+i.synthesis_comment:"");var r=t.find(".bars");r.html("");var o={unit_basic_info:"1.基本信息",unit_room_area:"2.面积尺寸",unit_region_flow:"3.分区流线",unit_window_ventilate:"4.采光通风",unit_detail:"5.细节"},l=0;for(var d in o){var s=o[d];a[d]&&a[d].score&&(Util.addHBar(r,{label:s,value:a[d].score+"分",percent:a[d].score,minWidth:"22%"}),l+=Number(a[d].score))}l>0&&(l/=5);var u=i.total_score;u=u?Number(u):l,updateScore(t,u=PageRenderer.formatScore(u,"分"))}function renderBasicInfo(e,a){var n="unit_basic_info",t=Util.convertToCssClassKey(n);renderCommon(e,a,n,t);var i=e.find("."+t),r=a[n];r||(r={});var o=i.find(".bars"),l=Math.max(r.sale_area,r.real_inside_area);if(o.html(""),r.efficiency){var d=Number(r.efficiency),s=(100*d).toFixed(1)+"%",u=getLevel("efficiency",d),c=getBadLevel("efficiency");Util.addHBar(o,{label:"实际得房率",value:s,percent:100*parseFloat(r.efficiency),level:u,badLevel:c})}r.real_inside_area&&Util.addHBar(o,{label:"实际套内面积(方)",value:r.real_inside_area,percent:100*r.real_inside_area/l}),r.sale_area&&Util.addHBar(o,{label:"建筑面积(方)",value:r.sale_area,percent:100*r.sale_area/l});var v=r.extra_info;if(v){var m=JSON.parse(v);if(m){var f=m.sendAreas,_=0;for(var h in f)_+=Number(f[h].size);for(var h in _=_.toFixed(1),Util.addHBar(o,{label:"总增值面积(方)",value:_,percent:100*_/l}),f)Util.addHBar(o,{label:f[h].name,value:f[h].size,percent:100*f[h].size/l})}}var p="";r.room_count&&r.living_room_count&&r.toliet_count&&(p=r.room_count+"室"+r.living_room_count+"厅"+r.toliet_count+"卫"),p&&Util.addHBar(o,{label:"户型配置",value:p,type:"plain_value"});var g=Util.formatRatioDisplay(r,"width","depth");g&&Util.addHBar(o,{label:"户型开进比",value:g,type:"plain_value",level:getLevel("unitWidthDepthRatio",g),badLevel:"D"});var y=Util.formatRatioDisplay(r,"square_perimeter","perimeter");y&&Util.addHBar(o,{label:"户型方正率",value:y,type:"plain_value",level:getLevel("unitSquareRatio",y),badLevel:"D"});var b=r.view_count;b=b?4*(b+num)+3:0,document.getElementById("see_count").innerHTML='<font color="#BEBEBE">'+b+"</font>"}function renderRoomArea(e,a){var n="unit_room_area",t=Util.convertToCssClassKey(n);renderCommon(e,a,n,t);var i=e.find("."+t),r=a[n],o=a.unit_basic_info;r||(r={});var l,d=i.find(".bars");d.html("");var s=r.extra_info;if(s){var u=JSON.parse(s);u&&(l=u.rooms)}if(l){var c=0;a.unit_basic_info&&a.unit_basic_info.real_inside_area&&(c=a.unit_basic_info.real_inside_area);var v=0,m=[];for(var f in l){var _=l[f];v=Math.max(_.area,v)}for(var f in l){_=l[f];var h="",p=Util.UNIT_STANDART[_.room_type];for(var g in p){if("passage"==_.room_type){if((c>0?_.area/c:0)<=p[g]){h=g;break}}else if("storage"==_.room_type){if((c>0?_.area/c:0)>=p[g]){h=g;break}}else if(_.area>=p[g]){h=g;break}}var y=getBadLevel(_.room_type),b=0,w="";["bed_room","study_room","living_room","dining_room","living_dining_room"].indexOf(_.room_type)>=0&&_.depth&&_.width&&(b=(_.width/_.depth).toFixed(2)),b&&b<=.7&&(b="<font style='color:red'>"+b+"</font>");var U="";if(b){U=b<=.7?"开进比 <font style='color:red'>"+b+"</font>":"开进比 "+b}if(w=U+"","storage"==_.room_type||"passage"==_.room_type){var B=o.real_inside_area,N=100*Number(_.area)/Number(B);w="占比 "+(N=N.toFixed(2))+"%"}m.push({label:_.room_name+"(方)",subLabel:w,value:_.area,percent:100*_.area/v,level:h,badLevel:y})}for(var f in m){var H=m[f];Util.addHBar(d,{label:H.label,subLabel:H.subLabel,value:H.value,percent:H.percent,level:H.level,badLevel:H.badLevel})}}}function renderRegionFlow(e,a){var n="unit_region_flow",t=Util.convertToCssClassKey(n);renderCommon(e,a,n,t);var i=e.find("."+t),r=a[n];r||(r={});var o=i.find(".bars");o.html(""),null!=r.static_region_count&&Util.addHBar(o,{label:"静区个数",value:r.static_region_count,type:"plain_value"}),null!=r.dynamic_region_count&&Util.addHBar(o,{label:"动区个数",value:r.dynamic_region_count,type:"plain_value"});var l,d=r.distances;d&&(l=JSON.parse(d));var s=0;for(var u in l)l[u].k&&l[u].v&&(s=Math.max(s,Number(l[u].v)));for(var u in l){var c=l[u],v=c.v;if(v){var m=getLevel("region_flow",Number(v),!0),f=getBadLevel("region_flow");Util.addHBar(o,{label:c.k,value:v,percent:100*v/s,level:m,badLevel:f})}}}function renderWindowAndVentilate(e,a){var n="unit_window_ventilate",t=Util.convertToCssClassKey(n);renderCommon(e,a,n,t);var i,r=e.find("."+t),o=a[n];o||(o={});var l=o.extra_info;l&&(i=JSON.parse(l));var d=r.find(".bars");if(d.html(""),i){var s=i.room_windows,u=i.ventilate;for(var c in s){(_=s[c]).ratio=Number(_.window_width)/Number(_.depth)}var v={},m=maxValues(s,"ratio"),f=getBadLevel("window_depth_ratio");for(var c in s){var _=s[c],h=getLevel("window_depth_ratio",isNaN(_.ratio)?0:_.ratio);_.ratio||(_.ratio=0);var p=(100*_.ratio).toFixed(1);Util.addHBar(d,{label:_.room_name+"窗深比",value:p+"%",percent:p/m,level:h,badLevel:f}),v[_.orientation]?v[_.orientation]++:v[_.orientation]=1}var g={south:"南房间数",north:"北房间数",east_west:"东西房间数",middle:"中庭房间数",no:"暗房间数"};for(var n in v)Util.addHBar(d,{label:g[n],value:v[n],type:"plain_value"});var y={1:"客厅->餐厅",2:"客厅->厨房/卫生间/卧室/书房",3:"卧室->客厅/餐厅",4:"卧室->厨房/卫生间/卧室/书房"};if(u){var b={south_north:{name:"南北通风+侧面通风",level:"A"},side:{name:"南北通风",level:"B"},middle:{name:"中庭通风",level:"C"},single_side:{name:"单面通风",level:"D"}}[u.type];if(Util.addHBar(d,{label:"通风类型",value:b.name,type:"plain_value",level:b.level,badLevel:"D"}),u.paths)for(var c in u.paths){var w=Number(c)+1,U=y[u.paths[c]];_.convect_type,_.ventilate_type;Util.addHBar(d,{label:"通风路径"+w,value:U,type:"plain_value"})}}}}function renderDetail(e,a){var n="unit_detail",t=Util.convertToCssClassKey(n);renderCommon(e,a,n,t);var i=e.find("."+t),r=a[n];r||(r={});var o=i.find(".sections");o.html("");var l={door:"门厅",living_room:"客厅",dining_room:"餐厅",bedroom:"卧室,书房",kitchen:"厨房",toliet:"卫生间",balcony:"阳台"},d=0;for(var s in l){var u,c=r[s];u=c?JSON.parse(c):{};var v=$($("#detail-section-tpl").html());v.find(".section-title").html(l[s]),v.find(".sections-items-wrap").html();var m=Util.UNIT_STANDART.detail_items[s];for(var f in m){d++;var _=u[Util.UNIT_STANDART.detai_item_key[f]],h=$($("#detail-section-item-tpl").html());h.find(".name").html(d+"."+m[f]),_?(h.find(".value").html("<img src='/image/checked.png'></img>"),h.find(".value").removeClass("color-warn")):(h.find(".value").html("<img src='/image/cross.png'></img>"),h.find(".value").addClass("color-warn")),v.find(".section-items-wrap").append(h)}o.append(v)}}function renderCommon(e,a,n,t){var i=e.find("."+t),r=a[n];r||(r={}),updateScore(i,PageRenderer.formatScore(r.score,"分"));var o=r.image_url;"undefined"==o&&(o=""),Util.renderImage(i,o),i.find(".comment").html(r.comment?"点评："+r.comment:"")}function updateScore(e,a){var n=e.find(".panel-title .score");a?n.html(a).show():n.hide()}function maxValues(e,a){var n=0;for(var t in e)isNaN(e[t][a])||(n=Math.max(e[t][a],n));return n}function getLevel(e,a,n){var t="",i=Util.UNIT_STANDART[e];for(var r in i){if(n?a<i[r]:a>=i[r]){t=r;break}}return t}function getBadLevel(e){var a=Util.UNIT_STANDART[e],n=0,t=null;return a&&(n=(t=Object.keys(a)).length),n<=0||!t?"D":t[n-1]}function toggleShowContent(e,a,n){n?(a.show(),e.hide()):(a.hide(),e.show())}$(function(){PageRenderer.initTitleBar();var e=getQueryStringValueByName("id",window.location.href);$(".tab-header .light a").on("click",function(){location.href="/detail.html?id="+e}),$.ajax({url:"/api/queryZan",data:{real_estate_id:e},dataType:"json",success:function(a){commonHandleResponse(a,function(n){num=a.data.zan_number,document.getElementById("zan-num").innerHTML='<font color="#BEBEBE">'+ ++num+"</font>",$(".zan").on("click",function(){$.ajax({url:"/api/zan",data:{real_estate_id:e,zan_number:1},dataType:"json",success:function(e){commonHandleResponse(e,function(e){document.getElementById("zan-num").innerHTML='<font color="#BEBEBE">'+ ++num+"</font>",document.getElementById("zan").innerHTML='<img src="image/zan_down.png" height="40" width="40">'})},error:function(e){console.log(e)}})})},function(a){num=0,document.getElementById("zan-num").innerHTML='<font color="#BEBEBE">'+num+"</font>",$(".zan").on("click",function(){$.ajax({url:"/api/zan",data:{real_estate_id:e,zan_number:1},dataType:"json",success:function(e){commonHandleResponse(e,function(e){document.getElementById("zan-num").innerHTML='<font color="#BEBEBE">'+ ++num+"</font>",document.getElementById("zan").innerHTML='<img src="image/zan_down.png" height="40" width="40">'})},error:function(e){console.log(e)}})})})},error:function(a){num=0,document.getElementById("zan-num").innerHTML='<font color="#BEBEBE">'+num+"</font>",$(".zan").on("click",function(){$.ajax({url:"/api/zan",data:{real_estate_id:e,zan_number:1},dataType:"json",success:function(e){commonHandleResponse(e,function(e){document.getElementById("zan-num").innerHTML="("+ ++num+")",document.getElementById("zan").innerHTML='<img src="image/zan_down.png" height="40" width="40">'})},error:function(e){console.log(e)}})})}}),$(window).on("hashchange",function(e){e.preventDefault(),switchUnitNoByHash(!0)}),switchUnitNoByHash(!1),trackUnitNoView(unitNo=getHashUnitNo())});