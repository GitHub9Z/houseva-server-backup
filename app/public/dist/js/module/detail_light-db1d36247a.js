var viewData=null;function getHourDisplay(i,t){var a=t?t+"_min":"hours_min",e=t?t+"_max":"hours_max",n=t||"hours";return i[a]&&i[e]&&i[a]!=i[e]?i[a]+"-"+i[e]:i[n]}function switchTabByHash(i){var t=Util.parseUrlHash(window.location.hash),a=t?t.type:"";a||(a="sitePlan"),switchLightType(a,i)}function switchLightType(i,t){i&&!t&&$(".nav-sub a[type='"+i+"']").closest("li").addClass("active"),jQuery.each($(".tab-body-light .tab-page"),function(t,a){i==$(a).attr("type")?$(a).show():$(a).hide()}),onTabChanged(i)}function onTabChanged(i){viewData?renderTabPage(viewData,i):queryData(i)}function queryData(i){var t=getQueryStringValueByName("id",window.location.href);$.ajax({url:"/api/queryEvaluateLightDetail",data:{id:t},dataType:"json",success:function(t){renderTabPage(viewData=t.data,i),Util.updateTitleTextBySitePlanData(t.data)},error:function(i){console.log("response: ",i)}})}function renderTabPage(i,t){var a=$(".tab-page[type='"+t+"']");a.attr("updateDisplay");"sitePlan"==t?renderSitePlan(viewData,a):"elevationPlan"==t?renderElevationPlanPage(viewData,a):"floor"==t&&renderFloorPage(viewData,a),showViewCount(i)}function renderSitePlan(i,t){var a=i?i.lightSitePlan:null;if(a){var e=geSitePlanBuildingAvgLightHour(a);if(e){var n=t.find(".building-avg-hours");n.html("");var o=maxStandartLightHours(e);e.forEach(function(i){var t=getHourDisplay(i);Util.addHBar(n,{label:i.buildingNo+"栋(h)",value:t,percent:100*i.hours/o,level:calcLightHourLevel(i.hours)})}),!0}a.comment&&Util.renderComment(t,a.comment),a.light_image_url?(t.find(".image-static-box img").attr("src",a.light_image_url),t.find(".number-box").show()):t.find(".number-box").hide(),a.effect_image_url&&t.find(".image-effect-box img").attr("src",a.effect_image_url)}toggleShowDetail(t,getEmptyView(),!a)}function getEmptyView(){return $(".empty-content-info")}function renderElevationPlanPage(i,t,a){var e=i?i.lightElevationPlans:null,n=e&&e.length>0;if(toggleShowDetail(t,getEmptyView(),!n),n){var o=t.find(".building-no-nav"),r="";if(!o.html()){for(var l in e){var u=e[l];r+="<li><a building-no='"+u.building_no+"'>"+u.building_no+"#</a></li>"}o.html(r)}a||(a=e[0].building_no),o.find("a").click(function(i){updateNavActiveOnItemClick($(this)),renderBuildingLight(e,t,$(this).attr("building-no"))});var h=o.find("a");for(var l in h)if($(h[l]).attr("building-no")==a){$(h[l]).click();break}t.attr("updateDisplay",!1)}}function renderBuildingLight(i,t,a){var e=null;for(var n in i)if(i[n].building_no==a){e=i[n];break}var o=t.find(".elevation-plan-page"),r=!isValidElevationItemData(e);if(toggleShowDetail(o,getEmptyView(),r),!r){var l=o.find(".head-box");e.building_angel?l.html("<div>朝向："+e.building_angel+"度</div>"):l.html("");var u=o.find(".desc-sub"),h=o.find(".hours-box");h.html("");var d=parseExtraInfoKey(e,"floor_light_info");if(d){var g=maxStandartLightHours(d);d.forEach(function(i){var t="";t=i.floorStart==i.floorEnd?i.floorStart+"层(h)":i.floorStart+"-"+i.floorEnd+"层(h)";var a=100*parseFloat(i.hours)/g,e=getHourDisplay(i);Util.addHBar(h,{label:t,value:e,subValue:i.comment,percent:a,level:calcLightHourLevel(i.hours),minWidth:"120px"})}),u.show()}else u.hide();Util.renderComment(o,e.comment),renderImage(o,e.light_image_url)}}function renderFloorPage(i,t,a){var e=i?i.lightFloors:null,n=e&&e.length>0;if(toggleShowDetail(t,getEmptyView(),!n),n){var o=t.find(".building-no-nav"),r=Util.groupArrayByKey(e,"building_no");o.html("");var l="",u="";for(var h in r){r[h];l+="<li><a building-no='"+h+"'>"+h+"栋</a></li>",u||(u=h)}o.html(l),a||(a=u),o.find("a").click(function(i){updateNavActiveOnItemClick($(this));var a=$(this).attr("building-no");renderFloorPageOnBuilding(r[a],t,a)});var d=o.find("a");for(var h in d)if($(d[h]).attr("building-no")==a){$(d[h]).click();break}}}function renderFloorPageOnBuilding(i,t,a){t.find(".floor-page"),t.find(".empty-content-info");var e=t.find(".floor-no-nav");e.html("");var n="",o="";for(var r in i){var l=i[r].floor_no;n+="<li><a floor-no='"+l+"'>"+l+"层</a></li>",o||(o=l)}e.html(n),e.find("a").click(function(e){updateNavActiveOnItemClick($(this));var n=$(this).attr("floor-no");renderFloorPageOnFloor(i,t,a,n)});e.find("a");o&&e.find("a[floor-no='"+o+"']").click()}function renderFloorPageOnFloor(i,t,a,e){var n=t.find(".floor-page"),o=null;if(i&&i.length>0)if(e){for(var r in i)if(i[r].floor_no==e){o=i[r];break}}else e=i[0].floor_no,o=i[0];var l=!isValidFloorItemData(o);if(toggleShowDetail(n,getEmptyView(),l),!l){var u=n.find(".hours-box");u.html("");var h=parseExtraInfoKey(o,"direction_hours");if(h&&h.south_hours&&h.east_hours&&h.west_hours){var d=maxFloorDirectionHours(h),g=["south_hours","east_hours","west_hours"];for(r=0;r<g.length;r++){var f=g[r],c=getDirectionLabel(f),s=h[f],v=getHourDisplay(h,f),m=100*parseFloat(s)/d;Util.addHBar(u,{label:c,value:v,subValue:"",percent:m,level:calcLightHourLevel(s),minWidth:"120px"})}}Util.renderComment(n,o.comment),renderImage(n,o.light_image_url)}}function renderImage(i,t){t?(i.find(".image-box img").attr("src",t),i.find(".number-box").show()):(i.find(".image-box img").attr("src",""),i.find(".number-box").hide())}function maxFloorDirectionHours(i){var t=0;for(var a in i)t=Math.max(t,parseFloat(i[a]));return t=Math.max(8,t)}function getDirectionLabel(i){return"south_hours"==i?"南面(h)":"east_hours"==i?"东面(h)":"west_hours"==i?"西面(h)":void 0}function isValidElevationItemData(i){return!(!i||!(i.light_image_url||i.extra_info||i.comment))}function isValidFloorItemData(i){return!(!i||!i.light_image_url&&!i.comment)}function toggleShowDetail(i,t,a){a?(t.show(),i.hide()):(t.hide(),i.show()),toggleShowBottomDesc(a)}function toggleShowBottomDesc(i){var t=$(".bottom-desc-box");i?t.hide():t.show()}function showViewCount(i){var t="";i&&i.lightSitePlan&&((t=i.lightSitePlan.view_count)||(t=0));""==t&&(t=0),$(".view-count-box .view-count").html(t)}$(function(){PageRenderer.initTitleBar();var i=getQueryStringValueByName("id",window.location.href);$(".tab-header .unit a").on("click",function(){location.href="/detailUnit.html?id="+i}),$(".nav-sub a").on("click",function(){updateNavActiveOnItemClick($(this));var i=Util.parseUrlHash(window.location.hash);i||(i={}),i.type=$(this).attr("type"),window.location.hash=Util.toHashString(i)}),$(window).on("hashchange",function(i){i.preventDefault(),switchTabByHash(!0)}),switchTabByHash(!1),Util.trackDataView({id:i,type:"light"})});